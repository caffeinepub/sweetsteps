{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 162,
  "summary": "SweetSteps is an Internet Computer (ICP) dapp with a Motoko backend canister and a React (Vite) single-page frontend. It uses DFINITY Internet Identity for authentication, bootstraps backend RBAC via a shared secret (non-blocking when unset), and gates a one-time onboarding flow. The frontend provides core routes for Landing, Signup/Login, a multi-step Onboarding wizard with plan preview carousel, Weekly/Daily dashboards, and a Chocolate Fridge rewards dashboard with period toggles and inventory cards. Styling is a chocolate-themed Tailwind/shadcn-ui design system using OKLCH tokens and Google Fonts. AI-generated content is sourced exclusively from an external proxy API (no direct provider calls) and is wired into onboarding plan generation, Weekly Mountain content, and Daily steps with strict request/response contracts plus loading/error UX. The repo also includes a reusable build/deploy template scaffold (Dockerfile, scripts, and canister configs) for packaging/exporting and deploying the app.",
  "existing_features": [
    {
      "id": "IF-1",
      "title": "Motoko role-based access control (RBAC) roles and state",
      "synonyms": [
        "AccessControl",
        "UserRole",
        "AccessControlState"
      ],
      "description": "Defines user roles (`#admin`, `#user`, `#guest`) and maintains an in-memory Principal→role map, including an `adminAssigned` flag for bootstrap behavior.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-2",
      "title": "Admin bootstrap via environment secret token",
      "synonyms": [
        "CAFFEINE_ADMIN_TOKEN",
        "initialize"
      ],
      "description": "Bootstraps admin assignment by comparing a user-provided token to the canister environment token; qualifying callers may become `#admin`, otherwise new callers become `#user` (anonymous treated as `#guest`).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-3",
      "title": "Authorization canister API exposed via Motoko mixin",
      "synonyms": [
        "MixinAuthorization",
        "_initializeAccessControlWithSecret"
      ],
      "description": "Exposes shared/query methods to initialize RBAC using a secret token and to support role queries and checks from outside the main actor module.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-4",
      "title": "Query caller role and admin status endpoints",
      "synonyms": [
        "getCallerUserRole",
        "isCallerAdmin"
      ],
      "description": "Provides query endpoints to fetch the caller’s current role and to check whether the caller is an admin.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-5",
      "title": "Admin-only role assignment endpoint",
      "synonyms": [
        "assignCallerUserRole",
        "assignRole"
      ],
      "description": "Allows admins to assign a role to an arbitrary Principal; non-admin callers are rejected by backend authorization checks.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-6",
      "title": "Backend user profile storage with onboarding completion flag",
      "synonyms": [
        "userProfiles",
        "onboardingCompleted"
      ],
      "description": "Stores per-principal user profile data (creation timestamp and onboarding completion boolean) in an in-memory map.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-7",
      "title": "Backend endpoint to mark onboarding complete (permission gated)",
      "synonyms": [
        "completeOnboarding"
      ],
      "description": "Authenticated callers with sufficient permission can mark onboarding complete; creates a profile on first completion and sets `onboardingCompleted = true`.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-8",
      "title": "Backend query to gate onboarding access",
      "synonyms": [
        "canAccessOnboarding"
      ],
      "description": "Returns whether an authenticated caller should see onboarding: true when no profile exists or onboarding has not been completed; otherwise false.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-9",
      "title": "Internet Identity authentication provider and hook",
      "synonyms": [
        "InternetIdentityProvider",
        "useInternetIdentity",
        "AuthClient"
      ],
      "description": "Provides identity persistence/restoration, login/logout, and granular login status flags (`initializing/idle/logging-in/success/loginError`) using `@dfinity/auth-client` and a configured derivation origin.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-10",
      "title": "Identity/session validation utilities",
      "synonyms": [
        "isIdentityValid",
        "isSessionStale",
        "delegation validity"
      ],
      "description": "Validates identities as non-anonymous and (for delegation identities) non-expired; detects stale sessions to trigger clearing before a new auth attempt.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-11",
      "title": "URL parameter parsing utilities (query + hash)",
      "synonyms": [
        "getUrlParameter",
        "getPersistedUrlParameter"
      ],
      "description": "Reads parameters from query strings or hash-based query fragments and supports persistence to sessionStorage.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-12",
      "title": "Secure secret extraction via hash + session persistence + URL cleanup",
      "synonyms": [
        "getSecretParameter",
        "getSecretFromHash",
        "clearParamFromHash"
      ],
      "description": "Extracts sensitive parameters from the URL hash, stores them in sessionStorage, and removes them from the address bar using `history.replaceState` to reduce leakage.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-13",
      "title": "Auth attempt lifecycle guard hook",
      "synonyms": [
        "useAuthAttemptGuard",
        "re-entrancy guard"
      ],
      "description": "Prevents multiple simultaneous auth attempts, exposes `isAttempting` for UI state, and records an attempt timestamp for downstream watchdog logic.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-14",
      "title": "Stalled authentication detection hook",
      "synonyms": [
        "useStalledAuthDetection",
        "popup blocked watchdog"
      ],
      "description": "After a user-initiated attempt, starts a timeout and exposes a boolean when login remains in a non-terminal state without an identity (e.g., popup blocked).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-15",
      "title": "Reusable auth popup-blocker help panel",
      "synonyms": [
        "AuthPopupHelpPanel"
      ],
      "description": "Displays inline guidance when the Internet Identity window likely didn’t open, includes a Retry action and a direct link to the configured II URL.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-16",
      "title": "Reusable auth error panel",
      "synonyms": [
        "AuthErrorPanel"
      ],
      "description": "Shows a user-friendly error message with optional Retry and Return-to-Landing actions; used for auth failures and onboarding check failures.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-17",
      "title": "Optional auth diagnostics panel (debug mode)",
      "synonyms": [
        "AuthDiagnosticsPanel",
        "debugAuth"
      ],
      "description": "When enabled via `?debugAuth=1`, displays the resolved Internet Identity URL and current auth flags for troubleshooting.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-18",
      "title": "Identity-aware backend actor creation and caching",
      "synonyms": [
        "useActor",
        "React Query actor cache"
      ],
      "description": "Creates an anonymous actor when logged out and an identity-bound actor when logged in; caches by principal and invalidates/refetches other queries when the actor changes.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-19",
      "title": "Frontend RBAC registration during authenticated actor creation",
      "synonyms": [
        "_initializeAccessControlWithSecret",
        "caffeineAdminToken"
      ],
      "description": "After creating an authenticated actor, reads `caffeineAdminToken` from the URL hash/session and calls `_initializeAccessControlWithSecret` to register the principal’s role on the backend.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-20",
      "title": "SPA routing for core pages",
      "synonyms": [
        "TanStack Router",
        "route tree"
      ],
      "description": "Defines client-side routes for Landing (/), Signup (/signup), Login (/login), Onboarding (/onboarding), Sweet Summit (/sweet-summit), Weekly Mountain (/weekly-mountain), Daily (/daily), and Chocolate Fridge (/fridge).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-21",
      "title": "Root layout wrapper providing onboarding result context",
      "synonyms": [
        "RootLayout",
        "OnboardingResultProvider"
      ],
      "description": "Wraps all routed content with `OnboardingResultProvider` so onboarding result state can be shared across pages without prop drilling.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-22",
      "title": "Onboarding result context schema and setter",
      "synonyms": [
        "OnboardingResultContext",
        "useOnboardingResult"
      ],
      "description": "Defines an in-memory context for onboarding answers (goal/currentStanding/timeframe) and a plan response (bigGoal/weeklyMountain/dailyStep) with a setter.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-23",
      "title": "Landing page hero with primary navigation CTAs",
      "synonyms": [
        "Landing",
        "Start Climbing",
        "Continue Climbing"
      ],
      "description": "Public landing page with SweetSteps branding, CTAs linking to signup and login routes, and footer attribution.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-24",
      "title": "Landing explainer modal carousel with keyboard controls",
      "synonyms": [
        "Why SweetSteps modal",
        "feature carousel"
      ],
      "description": "Modal overlay with multi-slide carousel, next/prev buttons, dot indicators, overlay click-to-close, and Escape/Arrow key navigation.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-26",
      "title": "Hardened Internet Identity signup flow",
      "synonyms": [
        "Signup page",
        "gesture-safe login"
      ],
      "description": "Implements signup via Internet Identity with synchronous `login()` invocation (preserving user gesture for popup reliability), stale-session clearing, identity validation, and stable UI state via explicit attempt phases.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-27",
      "title": "Hardened Internet Identity login flow with onboarding-based redirect",
      "synonyms": [
        "Login page",
        "canAccessOnboarding redirect"
      ],
      "description": "Logs in via Internet Identity, validates identity, checks backend onboarding status, and routes users to onboarding vs weekly dashboard, with retry/error UX and stalled-popup help.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-28",
      "title": "Onboarding access gating and multi-step onboarding wizard",
      "synonyms": [
        "Onboarding",
        "wizard",
        "completeOnboarding integration"
      ],
      "description": "Checks onboarding eligibility and redirects already-onboarded users to `/weekly-mountain`; redirects unauthenticated users to `/signup`; collects inputs over three steps, calls `actor.completeOnboarding()`, then shows a plan preview carousel step.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-29",
      "title": "Local placeholder onboarding plan generator",
      "synonyms": [
        "generatePlaceholderPlan",
        "mock onboarding plan"
      ],
      "description": "Generates contextual plan text locally (big goal, sample weekly mountain, sample daily step) based on onboarding answers without network calls.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-30",
      "title": "Sweet Summit standalone plan review page (context-based)",
      "synonyms": [
        "/sweet-summit",
        "plan review"
      ],
      "description": "Renders a plan summary (bigGoal, weeklyMountain, dailyStep) from `OnboardingResultContext`, and shows an empty-state prompt linking back to onboarding when no data is present.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-31",
      "title": "Weekly Mountain dashboard (placeholder progress and navigation)",
      "synonyms": [
        "/weekly-mountain",
        "weekly progress"
      ],
      "description": "Displays a placeholder weekly dashboard with progress percentage/bar and stats, navigation to Daily and Chocolate Fridge pages, and a coach’s note card.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-32",
      "title": "Daily SweetSteps placeholder page (no feet icons)",
      "synonyms": [
        "/daily",
        "Daily SweetSteps"
      ],
      "description": "Static placeholder UI for future daily task checklist functionality, with simplified header (no feet-related icon usage) and coming-soon messaging.",
      "reqIds": [
        "REQ-4"
      ],
      "version": 1
    },
    {
      "id": "IF-33",
      "title": "Chocolate Fridge rewards dashboard (full-height, header, period toggles, horizontal cards)",
      "synonyms": [
        "/fridge",
        "Chocolate Fridge",
        "inventory"
      ],
      "description": "Viewport-height constrained rewards dashboard with header text \"Your Chocolate Fridge\", mutually exclusive period toggle buttons, and horizontal (flex-row) inventory cards with reduced padding that display hardcoded counts per period.",
      "reqIds": [
        "REQ-1",
        "REQ-2",
        "REQ-3"
      ],
      "version": 1
    },
    {
      "id": "IF-34",
      "title": "AI endpoint configuration reader",
      "synonyms": [
        "getAIConfig",
        "VITE_AI_ENDPOINT_URL",
        "VITE_AI_API_KEY"
      ],
      "description": "Reads AI endpoint URL and API key from Vite environment variables and exposes an `isConfigured` flag to gate AI usage.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-35",
      "title": "OpenAI-compatible chat-completions AI client with strict JSON validation",
      "synonyms": [
        "callAIEndpoint",
        "Groq chat completions",
        "JSON-only response"
      ],
      "description": "Calls an OpenAI-compatible chat-completions endpoint with a JSON-only system prompt and validates the returned schema (`bigGoal`, `weeklyMountain {name, weeklyTarget, note}`, `dailyStep`) with user-friendly errors.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-36",
      "title": "Chocolate-themed design system (Tailwind + shadcn-ui + OKLCH tokens)",
      "synonyms": [
        "Tailwind theme",
        "shadcn-ui",
        "OKLCH tokens",
        "Cantata One",
        "Source Sans 3"
      ],
      "description": "Defines global OKLCH CSS variables mapped into Tailwind color tokens, border radii, and global typography rules; loads fonts via Google Fonts and maps them into Tailwind font families.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-37",
      "title": "Static hosting deep-link fallback for SPA routes",
      "synonyms": [
        "public/404.html",
        "SPA redirect"
      ],
      "description": "Implements a 404 fallback that redirects to `index.html` so direct navigation to client-side routes works on static/IC asset hosting.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-38",
      "title": "App bootstrap with React Query and Internet Identity provider",
      "synonyms": [
        "main.tsx",
        "QueryClientProvider"
      ],
      "description": "Bootstraps the React app by wiring `QueryClientProvider` and `InternetIdentityProvider` before rendering the router-based app and global styles.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-39",
      "title": "Daily SweetSteps renders mock steps from JSON shape",
      "synonyms": [
        "Daily steps JSON",
        "steps list mock"
      ],
      "description": "Updates the Daily SweetSteps page to work with a steps array in the shape `[{ task: string, time: number }]` and includes placeholder/mock values to preview the intended layout (no additional behavioral changes).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-40",
      "title": "Daily SweetSteps TaskModal with adjustable timer and completion callback",
      "synonyms": [
        "TaskModal",
        "Daily task modal",
        "timer modal"
      ],
      "description": "Adds a self-contained `TaskModal` component for Daily SweetSteps that displays task details, provides an adjustable timer (5–60 minutes) with start/pause/cancel using `setInterval`, confirms completion, triggers an `onComplete` reward callback, and fully resets internal state on close/cancel.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-41",
      "title": "Daily SweetSteps page header with date + simplified tasks container styling",
      "synonyms": [
        "Today's SweetSteps header",
        "Daily UI refresh",
        "tasks container border removal"
      ],
      "description": "Updates the Daily SweetSteps page UI to add a top-level header \"Today's SweetSteps\" with a date display, and simplifies the tasks list container by removing the card border/background and removing the in-card heading.",
      "reqIds": [
        "AR-1"
      ],
      "version": 1
    },
    {
      "id": "IF-42",
      "title": "Graceful/non-blocking RBAC initialization when CAFFEINE_ADMIN_TOKEN is missing",
      "synonyms": [
        "optional admin token",
        "RBAC init does not trap",
        "safe _initializeAccessControlWithSecret"
      ],
      "description": "Updates backend RBAC initialization to avoid trapping when CAFFEINE_ADMIN_TOKEN is unset/not usable, allowing Internet Identity login/signup flows to continue. Frontend auth/actor bootstrapping handles initialization failures explicitly and surfaces a recoverable error/warning rather than hanging indefinitely.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-43",
      "title": "Reusable build-template scaffold for packaging/exporting and deploying the ICP app",
      "synonyms": [
        "build-template",
        "deploy.sh",
        "icp.yaml",
        "Dockerfile",
        "github-export-icp-cli"
      ],
      "description": "Adds a `build-template/` directory containing deploy/config assets (Dockerfile, icp.yaml, canister YAMLs, scripts like prune/resize images, and frontend tooling configs) to support reproducible packaging/export and deployment of the SweetSteps backend/frontend.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-44",
      "title": "Mobile-friendly Internet Identity login helper with cancel/close recovery",
      "synonyms": [
        "useMobileInternetIdentityLogin",
        "popup close detection",
        "cancel recovery"
      ],
      "description": "Adds a dedicated mobile-oriented Internet Identity login helper that detects likely popup/chooser cancel/close or stalled initiation and ensures Login/Signup UI returns to a retryable state (avoids getting stuck in non-terminal phases like “Validating…”).",
      "reqIds": [
        "AR-2"
      ],
      "version": 1
    },
    {
      "id": "IF-45",
      "title": "Proxy-only AI generation wired into onboarding, Weekly Mountain, and Daily (strict contracts + UX)",
      "synonyms": [
        "aiProxyClient",
        "/onboarding-plan",
        "/weekly-mountain",
        "/daily-steps",
        "proxy AI integration"
      ],
      "description": "Implements an external proxy-only AI integration via a dedicated client that calls proxy endpoints for onboarding plan generation, weekly mountain content, and daily steps. Enforces strict request/response JSON shapes, provides loading states, and shows a user-friendly fallback error when the proxy is unreachable or returns invalid/non-JSON responses (no direct Groq/OpenAI calls from the browser).",
      "reqIds": [
        "AR-3"
      ],
      "version": 1
    },
    {
      "id": "IF-46",
      "title": "Always-visible auth validation status banner for Internet Identity flows",
      "synonyms": [
        "AuthStatusBanner",
        "auth validation steps",
        "always-on auth banner"
      ],
      "description": "Adds an always-visible in-app banner during login/signup that shows the current Internet Identity auth/redirect/validation step and provides clearer user feedback when auth appears stalled (no debug flag required).",
      "reqIds": [
        "AR-5",
        "AR-8"
      ],
      "version": 1
    },
    {
      "id": "IF-47",
      "title": "Auth flow diagnostics hook and utilities for step-level logging",
      "synonyms": [
        "useAuthFlowDiagnostics",
        "authDiagnostics",
        "auth step logging"
      ],
      "description": "Introduces a dedicated hook/utilities to track and log step-level progress through the Internet Identity auth lifecycle (init → login attempt → redirect/delegation → identity validation → backend/actor bootstrap) to help pinpoint where “Validating…” stalls occur.",
      "reqIds": [
        "AR-4",
        "AR-6",
        "AR-7",
        "AR-8"
      ],
      "version": 1
    },
    {
      "id": "IF-48",
      "title": "Username + password authentication (canister-stored hashed credentials) alongside Internet Identity",
      "synonyms": [
        "password auth",
        "local auth",
        "UsernamePasswordAuthForm",
        "usePasswordIdentity"
      ],
      "description": "Adds an alternative authentication path using a simple username+password flow. Credentials are stored and verified entirely in the Motoko canister using hashed passwords. Frontend includes UI and hooks to sign up/log in with username+password and use the resulting identity/session for actor creation. No Internet Identity ↔ password account linking flow is required at this stage.",
      "reqIds": [
        "AR-12"
      ],
      "version": 1
    },
    {
      "id": "IF-49",
      "title": "Backend canister warm-up preflight for auth flows (UI banner + hook)",
      "synonyms": [
        "canister warmup",
        "preflight ping",
        "useCanisterWarmup",
        "CanisterWarmupBanner"
      ],
      "description": "Adds a frontend warm-up/preflight call to the backend canister to reduce perceived 1–2 minute stalls when the canister is cold (especially during username/password signup/login). Includes a reusable hook to run/track warm-up status and a UI banner component to communicate warm-up progress and recovery/retry guidance.",
      "reqIds": [
        "AR-13"
      ],
      "version": 1
    },
    {
      "id": "IF-50",
      "title": "Guarded canister warm-up/preflight execution to prevent render/click loops (tab freeze fix)",
      "synonyms": [
        "warmup run-once",
        "preflight guard",
        "no retrigger loop",
        "AR-14 fix"
      ],
      "description": "Updates the canister warm-up/preflight logic used by auth flows to be strictly guarded (e.g., run-once per page load / in-flight dedupe) so it cannot retrigger in a render or repeated click loop that previously caused severe browser tab freezes during username/password signup/login.",
      "reqIds": [
        "AR-14"
      ],
      "version": 1
    },
    {
      "id": "IF-51",
      "title": "Backup SignupTest route/page for auth testing (II + username/password)",
      "synonyms": [
        "/signup-test",
        "SignupTest",
        "backup signup testing"
      ],
      "description": "Adds a separate SignupTest page/route intended for troubleshooting and testing signup flows without altering the primary Landing/Signup experience. The page supports Internet Identity signup and username+password fields/flow for comparison/testing.",
      "reqIds": [
        "AR-18"
      ],
      "version": 1
    },
    {
      "id": "IF-52",
      "title": "Isolated Motoko AltSignup backend module for backup signup flow",
      "synonyms": [
        "AltSignup.mo",
        "alternate signup module",
        "backup signup backend"
      ],
      "description": "Introduces a dedicated Motoko module/file to handle the backup SignupTest username/password signup logic in an isolated way, minimizing risk of disturbing the main authentication flows.",
      "reqIds": [
        "AR-19"
      ],
      "version": 1
    },
    {
      "id": "IF-53",
      "title": "Landing page test navigation updated to point to backup signup test route",
      "synonyms": [
        "Landing test button",
        "backup signup test button"
      ],
      "description": "Updates the Landing page’s temporary testing navigation so testers can reach the backup signup test route directly from the Landing page.",
      "reqIds": [
        "AR-20"
      ],
      "version": 1
    },
    {
      "id": "IF-54",
      "title": "SignupTest Internet Identity flow redirects to /onboarding after successful auth",
      "synonyms": [
        "/signup-test redirect",
        "useInternetIdentitySignupTest",
        "SignupTest II parity"
      ],
      "description": "Updates the backup `/signup-test` Internet Identity authentication flow so that, on successful authentication, the user is redirected to `/onboarding` (matching the primary Internet Identity signup behavior) rather than remaining on the test signup page.",
      "reqIds": [
        "AR-21"
      ],
      "version": 1
    },
    {
      "id": "IF-55",
      "title": "Patched Internet Identity OAuth/authorize callback handling with trusted-origin support",
      "synonyms": [
        "InternetIdentityAuthorizeCallbackHandler",
        "PatchedInternetIdentityProvider",
        "ii-alternative-origins",
        "#authorize hash redirect"
      ],
      "description": "Adds a patched Internet Identity integration to support OAuth-style callback flows by whitelisting the live frontend origin as an alternative/trusted origin and handling callback redirects back into the SPA via a `#authorize=<principal>` hash. The frontend parses the principal/authorization hash and completes the post-auth flow by redirecting users to `/onboarding` (with supporting patched mobile login helper).",
      "reqIds": [
        "AR-23"
      ],
      "version": 1
    },
    {
      "id": "feature-fix-the-main-signup-flow-so-that-after-internet-identity-authorization-the-app-does-not-remain-on-the-signup-page-in-a-validating-identity-state-for-300-seconds-ensure-the-ui-either-a-progresses-through-auth-steps-promptly-identity-validation-backend-actor-ready-routing-or-b-fails-fast-into-a-retryable-error-state-with-clear-instructions-rather-than-waiting-minutes-before-redirecting-to-onboarding",
      "title": "Fix the main /signup flow so that after Internet Identity authorization the app does not remain on the Signup page in a “Validating identity…” state for ~300 seconds. Ensure the UI either (a) progresses through auth steps promptly (identity validation → backend actor ready → routing) or (b) fails fast into a retryable error state with clear instructions, rather than waiting minutes before redirecting to /onboarding.",
      "reqIds": [
        "REQ-5"
      ],
      "version": 1
    },
    {
      "id": "feature-fix-the-onboarding-flow-crash-that-occurs-after-answering-onboarding-questions-reported-as-minified-react-error-31-attempting-to-render-an-object-with-keys-deadline-name-progress-reason-ensure-onboarding-plan-preview-rendering-never-attempts-to-directly-render-a-non-react-object-it-must-safely-render-strings-reactnodes-only-and-gracefully-handle-unexpected-ai-response-shapes",
      "title": "Fix the Onboarding flow crash that occurs after answering onboarding questions, reported as “Minified React error #31” attempting to render an object with keys {deadline, name, progress, reason}. Ensure onboarding plan preview rendering never attempts to directly render a non-React object; it must safely render strings/ReactNodes only, and gracefully handle unexpected AI response shapes.",
      "reqIds": [
        "REQ-6"
      ],
      "version": 1
    },
    {
      "id": "feature-update-login-behavior-so-the-internet-identity-account-chooser-is-shown-on-every-explicit-user-login-click-force-account-selection-rather-than-silently-reusing-an-existing-internet-identity-session-this-must-work-reliably-on-mobile-as-well-as-desktop",
      "title": "Update Login behavior so the Internet Identity account chooser is shown on every explicit user Login click (force account selection rather than silently reusing an existing Internet Identity session). This must work reliably on mobile as well as desktop.",
      "reqIds": [
        "REQ-7"
      ],
      "version": 1
    },
    {
      "id": "feature-ensure-the-auth-ui-state-machine-signup-login-cannot-remain-in-a-non-terminal-state-after-a-completed-internet-identity-authorization-specifically-add-explicit-timeouts-guards-for-post-ii-steps-identity-validation-actor-readiness-onboarding-check-navigation-so-the-ui-either-completes-routing-or-shows-an-error-with-retry-without-multi-minute-waits",
      "title": "Ensure the auth UI state machine (Signup + Login) cannot remain in a non-terminal state after a completed Internet Identity authorization. Specifically, add explicit timeouts/guards for post-II steps (identity validation, actor readiness, onboarding check/navigation) so the UI either completes routing or shows an error with Retry without multi-minute waits.",
      "reqIds": [
        "REQ-8"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [
    {
      "id": "AR-6",
      "summary": "Review and verify the Internet Identity redirect/delegation handling code path to confirm it is correctly implemented (no hangs/awaits that never resolve) and identify where validation can stall.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-7",
      "summary": "Review end-to-end Internet Identity post-redirect validation flow, including frontend redirect/delegation handling plus RBAC bootstrap and post-login actor setup, to identify causes of long 'Validating…' stalls.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-9",
      "summary": "Improve AI proxy call error handling/messaging to better explain unreachable/inactive (Render free tier cold start) scenarios, with clearer guidance (e.g., expected wake-up delay, retry suggestions) across all AI-powered flows.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-10",
      "summary": "Update UI styling so element/token \"1kltrkn\" uses the same color as \"14f6tu6\".",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-11",
      "summary": "Make Internet Identity login/signup feel fast by adding stricter stalled-auth timeouts (force-fail sooner), improving popup/chooser open detection, and ensuring the UI always returns quickly to a retryable state.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-16",
      "summary": "Investigate and fix the signup freeze/hang (Internet Identity signup flow getting stuck/loading, including cases where the II popup/chooser never opens and post-login validation stalls).",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-17",
      "summary": "Investigate and fix new full-page UI freeze/unresponsive inputs/buttons on Signup page (and Caffeine AI page) where clicking anything causes the page to hang.",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-22",
      "summary": "Allow users who authenticated via Internet Identity but exited before completing onboarding to be prompted to choose an II account again (provide a clear 'reset identity' / force account chooser flow, especially for the backup /signup-test path).",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-24",
      "summary": "Fix Weekly Mountain dashboard so first-time users see 0% progress (no sample/placeholder progress shown after onboarding).",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-25",
      "summary": "Fix Daily SweetSteps crash when navigating from Weekly Mountain (\"Cannot read properties of undefined (reading 'map')\"); ensure tasks array is always defined or guarded.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-26",
      "summary": "Update login behavior so returning users with an already-created account are routed directly to /weekly-mountain (instead of onboarding), while still correctly handling users who have not completed onboarding.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-27",
      "summary": "Remove username/password authentication UI fields completely (deprecate/disable the alternative username+password auth path so Internet Identity is the only login method).",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-28",
      "summary": "Investigate and fix ~300s post-Internet-Identity redirect stall on main /signup flow where UI stays on “Validating identity…” before eventually proceeding to onboarding (mobile; no status banner step changes).",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-29",
      "summary": "Fix onboarding flow crash after answering questions: Minified React error #31 (attempting to render an object with keys {deadline, name, progress, reason}) during onboarding/plan preview rendering.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-30",
      "summary": "Ensure Internet Identity account chooser is shown on every Login click (force account selection rather than silently reusing an existing II session), including reliable popup behavior on mobile.",
      "reqIds": [],
      "status": "pending"
    }
  ],
  "architectural_notes": [
    "Monorepo split into `backend/` (Motoko canister) and `frontend/` (React SPA).",
    "Backend composes authorization endpoints via a Motoko `mixin` (MixinAuthorization) included into the main actor with a shared mutable `AccessControlState`.",
    "RBAC is implemented as an in-memory Principal→role map with roles `#admin/#user/#guest`; admin assignment depends on a canister environment variable (`CAFFEINE_ADMIN_TOKEN`) plus a user-provided token passed from the frontend.",
    "Frontend authentication is encapsulated in a React context/provider built on `@dfinity/auth-client`, with explicit login status flags and support for long-lived delegations (30 days).",
    "Backend actor creation is centralized in `useActor` and cached via React Query keyed by principal; when the actor changes, other queries are invalidated/refetched.",
    "Sensitive bootstrap secrets (e.g., `caffeineAdminToken`) are expected in the URL hash, persisted in `sessionStorage`, and removed from the address bar via `history.replaceState`.",
    "Client routing uses TanStack Router with a root layout and route-based pages.",
    "UI uses Tailwind + shadcn-ui components, with global OKLCH CSS-variable tokens and Google Fonts (Cantata One + Source Sans 3).",
    "AI generation is performed exclusively via an external proxy API client (`aiProxyClient`) with strict request/response contracts (no direct provider calls from the frontend).",
    "Internet Identity (II) is the only supported authentication method; username/password auth UI has been removed/disabled."
  ],
  "known_issues": [
    "Backend RBAC assignments and onboarding completion state are stored in non-stable, in-memory maps; canister upgrades/reinstalls will lose roles and onboarding completion data.",
    "Login and signup flows still hang (non-terminal auth state) after latest deployment; likely related to RBAC bootstrap/init or stalled Internet Identity popup handling and needs investigation.",
    "In the current \"drafts\" build, Internet Identity popup/chooser never opens for login/signup (hang occurs before II window appears), suggesting a user-gesture/popup-blocking issue or stalled auth initiation.",
    "In drafts build on Chrome mobile: tapping Login/Sign Up shows button loading spinner but Internet Identity popup/chooser never opens; no popup-blocked indicator is shown.",
    "AI proxy hosted on Render free tier may be asleep/cold-starting, causing long waits or 'Unable to reach AI' errors; current messaging is too minimal and should better guide users (wake-up delay + retry).",
    "Internet Identity login/signup can take an excessively long time when the popup/chooser fails to open; needs faster timeout/failover so the UI returns quickly to a retryable state.",
    "Weekly Mountain dashboard shows sample/placeholder progress for first-time users after onboarding; should start at 0% progress.",
    "Daily SweetSteps can crash when navigating from Weekly Mountain (\"Cannot read properties of undefined (reading 'map')\"); tasks array is undefined and must be guarded/defaulted.",
    "Main /signup flow on mobile can stall ~300s after Internet Identity authorization while stuck on “Validating identity…” (auth status banner does not advance), then eventually proceeds to Onboarding.",
    "Onboarding flow can crash after answering questions with Minified React error #31 (attempting to render an object with keys {deadline, name, progress, reason}) during onboarding/plan preview rendering."
  ],
  "isFixRequest": true,
  "gameProjectType": "none",
  "projectName": "SweetSteps",
  "clarification_mode": "pro",
  "clarification_rounds": 0
}