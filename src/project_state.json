{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 20,
  "summary": "SweetSteps is an Internet Computer (ICP) dapp with a Motoko backend canister and a React (Vite) single-page frontend. It uses DFINITY Internet Identity for authentication, bootstraps backend RBAC via a shared secret, and gates a one-time onboarding flow that generates a placeholder (or optionally AI-generated) goal plan. The frontend provides core routes for Landing, Signup/Login, a multi-step Onboarding wizard with a plan preview carousel, placeholder Weekly/Daily dashboards, and a Chocolate Fridge rewards dashboard with period toggles and inventory cards. Styling is a chocolate-themed Tailwind/shadcn-ui design system using OKLCH tokens and Google Fonts.",
  "existing_features": [
    {
      "id": "IF-1",
      "title": "Motoko role-based access control (RBAC) roles and state",
      "synonyms": [
        "AccessControl",
        "UserRole",
        "AccessControlState"
      ],
      "description": "Defines user roles (`#admin`, `#user`, `#guest`) and maintains an in-memory Principal→role map, including an `adminAssigned` flag for bootstrap behavior.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-2",
      "title": "Admin bootstrap via environment secret token",
      "synonyms": [
        "CAFFEINE_ADMIN_TOKEN",
        "initialize"
      ],
      "description": "Bootstraps admin assignment by comparing a user-provided token to the canister environment token; qualifying callers may become `#admin`, otherwise new callers become `#user` (anonymous treated as `#guest`).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-3",
      "title": "Authorization canister API exposed via Motoko mixin",
      "synonyms": [
        "MixinAuthorization",
        "_initializeAccessControlWithSecret"
      ],
      "description": "Exposes shared/query methods to initialize RBAC using a secret token and to support role queries and checks from outside the main actor module.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-4",
      "title": "Query caller role and admin status endpoints",
      "synonyms": [
        "getCallerUserRole",
        "isCallerAdmin"
      ],
      "description": "Provides query endpoints to fetch the caller’s current role and to check whether the caller is an admin.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-5",
      "title": "Admin-only role assignment endpoint",
      "synonyms": [
        "assignCallerUserRole",
        "assignRole"
      ],
      "description": "Allows admins to assign a role to an arbitrary Principal; non-admin callers are rejected by backend authorization checks.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-6",
      "title": "Backend user profile storage with onboarding completion flag",
      "synonyms": [
        "userProfiles",
        "onboardingCompleted"
      ],
      "description": "Stores per-principal user profile data (creation timestamp and onboarding completion boolean) in an in-memory map.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-7",
      "title": "Backend endpoint to mark onboarding complete (permission gated)",
      "synonyms": [
        "completeOnboarding"
      ],
      "description": "Authenticated callers with sufficient permission can mark onboarding complete; creates a profile on first completion and sets `onboardingCompleted = true`.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-8",
      "title": "Backend query to gate onboarding access",
      "synonyms": [
        "canAccessOnboarding"
      ],
      "description": "Returns whether an authenticated caller should see onboarding: true when no profile exists or onboarding has not been completed; otherwise false.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-9",
      "title": "Internet Identity authentication provider and hook",
      "synonyms": [
        "InternetIdentityProvider",
        "useInternetIdentity",
        "AuthClient"
      ],
      "description": "Provides identity persistence/restoration, login/logout, and granular login status flags (`initializing/idle/logging-in/success/loginError`) using `@dfinity/auth-client` and a configured derivation origin.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-10",
      "title": "Identity/session validation utilities",
      "synonyms": [
        "isIdentityValid",
        "isSessionStale",
        "delegation validity"
      ],
      "description": "Validates identities as non-anonymous and (for delegation identities) non-expired; detects stale sessions to trigger clearing before a new auth attempt.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-11",
      "title": "URL parameter parsing utilities (query + hash)",
      "synonyms": [
        "getUrlParameter",
        "getPersistedUrlParameter"
      ],
      "description": "Reads parameters from query strings or hash-based query fragments and supports persistence to sessionStorage.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-12",
      "title": "Secure secret extraction via hash + session persistence + URL cleanup",
      "synonyms": [
        "getSecretParameter",
        "getSecretFromHash",
        "clearParamFromHash"
      ],
      "description": "Extracts sensitive parameters from the URL hash, stores them in sessionStorage, and removes them from the address bar using `history.replaceState` to reduce leakage.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-13",
      "title": "Auth attempt lifecycle guard hook",
      "synonyms": [
        "useAuthAttemptGuard",
        "re-entrancy guard"
      ],
      "description": "Prevents multiple simultaneous auth attempts, exposes `isAttempting` for UI state, and records an attempt timestamp for downstream watchdog logic.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-14",
      "title": "Stalled authentication detection hook",
      "synonyms": [
        "useStalledAuthDetection",
        "popup blocked watchdog"
      ],
      "description": "After a user-initiated attempt, starts a timeout and exposes a boolean when login remains in a non-terminal state without an identity (e.g., popup blocked).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-15",
      "title": "Reusable auth popup-blocker help panel",
      "synonyms": [
        "AuthPopupHelpPanel"
      ],
      "description": "Displays inline guidance when the Internet Identity window likely didn’t open, includes a Retry action and a direct link to the configured II URL.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-16",
      "title": "Reusable auth error panel",
      "synonyms": [
        "AuthErrorPanel"
      ],
      "description": "Shows a user-friendly error message with optional Retry and Return-to-Landing actions; used for auth failures and onboarding check failures.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-17",
      "title": "Optional auth diagnostics panel (debug mode)",
      "synonyms": [
        "AuthDiagnosticsPanel",
        "debugAuth"
      ],
      "description": "When enabled via `?debugAuth=1`, displays the resolved Internet Identity URL and current auth flags for troubleshooting.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-18",
      "title": "Identity-aware backend actor creation and caching",
      "synonyms": [
        "useActor",
        "React Query actor cache"
      ],
      "description": "Creates an anonymous actor when logged out and an identity-bound actor when logged in; caches by principal and invalidates/refetches other queries when the actor changes.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-19",
      "title": "Frontend RBAC registration during authenticated actor creation",
      "synonyms": [
        "_initializeAccessControlWithSecret",
        "caffeineAdminToken"
      ],
      "description": "After creating an authenticated actor, reads `caffeineAdminToken` from the URL hash/session and calls `_initializeAccessControlWithSecret` to register the principal’s role on the backend.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-20",
      "title": "SPA routing for core pages",
      "synonyms": [
        "TanStack Router",
        "route tree"
      ],
      "description": "Defines client-side routes for Landing (/), Signup (/signup), Login (/login), Onboarding (/onboarding), Sweet Summit (/sweet-summit), Weekly Mountain (/weekly-mountain), Daily (/daily), and Chocolate Fridge (/fridge).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-21",
      "title": "Root layout wrapper providing onboarding result context",
      "synonyms": [
        "RootLayout",
        "OnboardingResultProvider"
      ],
      "description": "Wraps all routed content with `OnboardingResultProvider` so onboarding result state can be shared across pages without prop drilling.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-22",
      "title": "Onboarding result context schema and setter",
      "synonyms": [
        "OnboardingResultContext",
        "useOnboardingResult"
      ],
      "description": "Defines an in-memory context for onboarding answers (goal/currentStanding/timeframe) and a plan response (bigGoal/weeklyMountain/dailyStep) with a setter.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-23",
      "title": "Landing page hero with primary navigation CTAs",
      "synonyms": [
        "Landing",
        "Start Climbing",
        "Continue Climbing"
      ],
      "description": "Public landing page with SweetSteps branding, CTAs linking to signup and login routes, and footer attribution.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-24",
      "title": "Landing explainer modal carousel with keyboard controls",
      "synonyms": [
        "Why SweetSteps modal",
        "feature carousel"
      ],
      "description": "Modal overlay with multi-slide carousel, next/prev buttons, dot indicators, overlay click-to-close, and Escape/Arrow key navigation.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-25",
      "title": "Temporary public test shortcuts to feature pages",
      "synonyms": [
        "Landing test links",
        "/daily",
        "/fridge"
      ],
      "description": "Provides clearly labeled temporary buttons on the landing page that navigate directly to `/daily` and `/fridge` for UI testing.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-26",
      "title": "Hardened Internet Identity signup flow",
      "synonyms": [
        "Signup page",
        "gesture-safe login"
      ],
      "description": "Implements signup via Internet Identity with synchronous `login()` invocation (preserving user gesture for popup reliability), stale-session clearing, identity validation, and stable UI state via explicit attempt phases.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-27",
      "title": "Hardened Internet Identity login flow with onboarding-based redirect",
      "synonyms": [
        "Login page",
        "canAccessOnboarding redirect"
      ],
      "description": "Logs in via Internet Identity, validates identity, checks backend onboarding status, and routes users to onboarding vs weekly dashboard, with retry/error UX and stalled-popup help.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-28",
      "title": "Onboarding access gating and multi-step onboarding wizard",
      "synonyms": [
        "Onboarding",
        "wizard",
        "completeOnboarding integration"
      ],
      "description": "Checks onboarding eligibility and redirects already-onboarded users to `/weekly-mountain`; redirects unauthenticated users to `/signup`; collects inputs over three steps, calls `actor.completeOnboarding()`, then shows a plan preview carousel step.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-29",
      "title": "Local placeholder onboarding plan generator",
      "synonyms": [
        "generatePlaceholderPlan",
        "mock onboarding plan"
      ],
      "description": "Generates contextual plan text locally (big goal, sample weekly mountain, sample daily step) based on onboarding answers without network calls.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-30",
      "title": "Sweet Summit standalone plan review page (context-based)",
      "synonyms": [
        "/sweet-summit",
        "plan review"
      ],
      "description": "Renders a plan summary (bigGoal, weeklyMountain, dailyStep) from `OnboardingResultContext`, and shows an empty-state prompt linking back to onboarding when no data is present.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-31",
      "title": "Weekly Mountain dashboard (placeholder progress and navigation)",
      "synonyms": [
        "/weekly-mountain",
        "weekly progress"
      ],
      "description": "Displays a placeholder weekly dashboard with progress percentage/bar and stats, navigation to Daily and Chocolate Fridge pages, and a coach’s note card.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-32",
      "title": "Daily SweetSteps placeholder page (no feet icons)",
      "synonyms": [
        "/daily",
        "Daily SweetSteps"
      ],
      "description": "Static placeholder UI for future daily task checklist functionality, with simplified header (no feet-related icon usage) and coming-soon messaging.",
      "reqIds": [
        "REQ-4"
      ],
      "version": 1
    },
    {
      "id": "IF-33",
      "title": "Chocolate Fridge rewards dashboard (full-height, header, period toggles, horizontal cards)",
      "synonyms": [
        "/fridge",
        "Chocolate Fridge",
        "inventory"
      ],
      "description": "Viewport-height constrained rewards dashboard with header text \"Your Chocolate Fridge\", mutually exclusive period toggle buttons, and horizontal (flex-row) inventory cards with reduced padding that display hardcoded counts per period.",
      "reqIds": [
        "REQ-1",
        "REQ-2",
        "REQ-3"
      ],
      "version": 1
    },
    {
      "id": "IF-34",
      "title": "AI endpoint configuration reader",
      "synonyms": [
        "getAIConfig",
        "VITE_AI_ENDPOINT_URL",
        "VITE_AI_API_KEY"
      ],
      "description": "Reads AI endpoint URL and API key from Vite environment variables and exposes an `isConfigured` flag to gate AI usage.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-35",
      "title": "OpenAI-compatible chat-completions AI client with strict JSON validation",
      "synonyms": [
        "callAIEndpoint",
        "Groq chat completions",
        "JSON-only response"
      ],
      "description": "Calls an OpenAI-compatible chat-completions endpoint with a JSON-only system prompt and validates the returned schema (`bigGoal`, `weeklyMountain {name, weeklyTarget, note}`, `dailyStep`) with user-friendly errors.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-36",
      "title": "Chocolate-themed design system (Tailwind + shadcn-ui + OKLCH tokens)",
      "synonyms": [
        "Tailwind theme",
        "shadcn-ui",
        "OKLCH tokens",
        "Cantata One",
        "Source Sans 3"
      ],
      "description": "Defines global OKLCH CSS variables mapped into Tailwind color tokens, border radii, and global typography rules; loads fonts via Google Fonts and maps them into Tailwind font families.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-37",
      "title": "Static hosting deep-link fallback for SPA routes",
      "synonyms": [
        "public/404.html",
        "SPA redirect"
      ],
      "description": "Implements a 404 fallback that redirects to `index.html` so direct navigation to client-side routes works on static/IC asset hosting.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-38",
      "title": "App bootstrap with React Query and Internet Identity provider",
      "synonyms": [
        "main.tsx",
        "QueryClientProvider"
      ],
      "description": "Bootstraps the React app by wiring `QueryClientProvider` and `InternetIdentityProvider` before rendering the router-based app and global styles.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-39",
      "title": "Daily SweetSteps renders mock steps from JSON shape",
      "synonyms": [
        "Daily steps JSON",
        "steps list mock"
      ],
      "description": "Updates the Daily SweetSteps page to work with a steps array in the shape `[{ task: string, time: number }]` and includes placeholder/mock values to preview the intended layout (no additional behavioral changes).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "feature-create-a-new-fully-self-contained-react-component-named-taskmodal-typescript-jsx-hooks-that-renders-a-centered-modal-overlay-for-a-daily-sweetstep-task-including-an-adjustable-countdown-timer-start-pause-cancel-and-a-completion-confirmation-step-that-triggers-callbacks",
      "title": "Create a new fully self-contained React component named `TaskModal` (TypeScript + JSX + hooks) that renders a centered modal overlay for a Daily SweetStep task, including an adjustable countdown timer (start/pause/cancel) and a completion confirmation step that triggers callbacks.",
      "reqIds": [
        "REQ-5"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [
    {
      "id": "AR-2",
      "summary": "Implement a fully self-contained TaskModal React component for Daily SweetSteps. Props: isOpen:boolean; task:{title, description, estimatedMinutes}; onClose(); onComplete(). If !isOpen return null. UI: centered modal w/ dark backdrop; card shows title/description/estimated minutes; slider to adjust timer 5–60 minutes; Start Timer. While running: countdown mm:ss, Pause, Cancel. When ends: prompt “Did you finish this task?” YES => onComplete + close; NO => reset timer UI. Logic: setInterval 1s; pause stops interval without reset; cancel and close fully reset internal state. SweetSteps dark palette, smooth fade-in, rounded + shadow. Frontend-only; no backend calls; no other file changes.",
      "reqIds": [],
      "status": "pending"
    }
  ],
  "architectural_notes": [
    "Monorepo split into `backend/` (Motoko canister) and `frontend/` (React SPA).",
    "Backend composes authorization endpoints via a Motoko `mixin` (MixinAuthorization) included into the main actor with a shared mutable `AccessControlState`.",
    "RBAC is implemented as an in-memory Principal→role map with roles `#admin/#user/#guest`; admin assignment depends on a canister environment variable (`CAFFEINE_ADMIN_TOKEN`) plus a user-provided token passed from the frontend.",
    "Frontend authentication is encapsulated in a React context/provider built on `@dfinity/auth-client`, with explicit login status flags and support for long-lived delegations (30 days).",
    "Backend actor creation is centralized in `useActor` and cached via React Query keyed by principal; when the actor changes, other queries are invalidated/refetched.",
    "Sensitive bootstrap secrets (e.g., `caffeineAdminToken`) are expected in the URL hash, persisted in `sessionStorage`, and removed from the address bar via `history.replaceState`.",
    "Client routing uses TanStack Router with a root layout and route-based pages.",
    "UI uses Tailwind + shadcn-ui components, with global OKLCH CSS-variable tokens and Google Fonts (Cantata One + Source Sans 3).",
    "SPA deep-link support is implemented via `public/404.html` redirecting to `index.html` for static/IC asset hosting.",
    "An AI client exists for OpenAI-compatible chat-completions (defaulting to Groq), but onboarding currently uses a local placeholder generator rather than wiring the AI client into the onboarding flow.",
    "Introduced a `build-template/` scaffold containing a full ICP project template (backend/frontend canister.yaml, Dockerfile, deploy scripts, workspace/package manifests) intended for reproducible builds and exports (e.g., GitHub/ICP CLI workflows).",
    "Added `build-template/` maintenance scripts for asset/image processing (`prune-unused-images.js`, `resize-images.js`) as part of the template toolchain.",
    "Expanded `build-template/src/frontend/` to include a comprehensive shadcn-ui component set and supporting config (eslint rules/config, postcss, tsconfig, vite config), establishing the template’s baseline UI/component library footprint.",
    "`build-template/` expanded into a more complete exportable ICP CLI/GitHub-ready scaffold, adding top-level project metadata and tooling (e.g., Dockerfile, LICENSE/README, deploy script, icp.yaml, pnpm workspace/package manifests and lockfile).",
    "Daily SweetSteps task interaction will use a self-contained TaskModal controlled by props (isOpen, task, onClose, onComplete); internal timer uses setInterval and must fully reset on close/cancel.",
    "TaskModal spec update: task prop shape is { title, description, estimatedMinutes }; modal is self-contained, returns null when closed, uses setInterval(1s) for countdown with pause/cancel, and must fully reset internal state on cancel/close; slider adjusts duration (5–60 min) and completion confirmation triggers onComplete then closes."
  ],
  "known_issues": [
    "Backend RBAC assignments and onboarding completion state are stored in non-stable, in-memory maps; canister upgrades/reinstalls will lose roles and onboarding completion data.",
    "`AccessControl.getUserRole` traps for any non-anonymous principal not registered via initialization; since `hasPermission()` calls `getUserRole()`, permission-gated methods can trap if `_initializeAccessControlWithSecret` was not successfully called.",
    "`_initializeAccessControlWithSecret` traps if the `CAFFEINE_ADMIN_TOKEN` environment variable is not set; because the frontend calls this during authenticated actor creation, auth flows can break entirely when the canister is misconfigured.",
    "`OnboardingResultContext` exists and `SweetSummit` reads from it, but `Onboarding.tsx` never calls `setOnboardingResult`, so navigating to `/sweet-summit` typically shows the empty-state screen.",
    "The AI client reads `VITE_AI_API_KEY` in the browser; enabling it exposes the key to end users unless moved behind a trusted backend/proxy.",
    "Modal/carousel UIs (Landing and Onboarding step 4) do not implement full dialog accessibility (e.g., focus trapping, `role=\"dialog\"`, `aria-modal`).",
    "`WeeklyMountain.tsx` imports `Mountain` from `lucide-react` but does not use it (minor lint issue).",
    "There is an empty/redundant `frontend/index.css` alongside `frontend/src/index.css`, which can confuse contributors about the single source of truth for global styles.",
    "Chocolate Fridge period toggle buttons (e.g., \"All Time\") can be cut off due to full-height/no-scroll layout; needs reduced padding/more compact toggle row."
  ],
  "isFixRequest": false,
  "gameProjectType": "none",
  "projectName": "SweetSteps",
  "clarification_mode": "pro",
  "clarification_rounds": 0
}